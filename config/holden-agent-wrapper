#!/bin/bash
# Wrapper script for holden-agent with configuration loading
# Part of the Holden process orchestration system

CONFIG_FILE="/etc/holden/agent.conf"

# Source configuration if it exists
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# Export environment variables with defaults
export SOCKET_PATH="${SOCKET_PATH:-/tmp/holden_orchestrator.sock}"
export MAX_PROCESSES="${MAX_PROCESSES:-64}"
export ENABLE_CGROUPS="${ENABLE_CGROUPS:-true}"
export CGROUP_BASE="${CGROUP_BASE:-/sys/fs/cgroup/holden}"
export LOG_LEVEL="${LOG_LEVEL:-info}"
export MONITOR_INTERVAL="${MONITOR_INTERVAL:-10}"
export MAX_RESTART_ATTEMPTS="${MAX_RESTART_ATTEMPTS:-3}"
export PROCESS_TIMEOUT="${PROCESS_TIMEOUT:-30}"

# Log startup information
if [ "$LOG_LEVEL" = "debug" ]; then
    echo "Holden Agent starting with configuration:"
    echo "  Socket: $SOCKET_PATH"
    echo "  Max processes: $MAX_PROCESSES"
    echo "  cgroups: $ENABLE_CGROUPS"
    echo "  cgroups base: $CGROUP_BASE"
fi

# Start the agent
exec /usr/sbin/holden-agent "$@"